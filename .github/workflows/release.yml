name: Create Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (leave empty to use package.json version)'
        required: false
        type: string
      previous_tag:
        description: 'Previous tag to compare (leave empty for auto-detect)'
        required: false
        type: string

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      models: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: yarn

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Get version
        id: version
        run: |
          if [ -n "${{ inputs.version }}" ]; then
            VERSION="${{ inputs.version }}"
          else
            VERSION=$(node -p "require('./package.json').version")
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=v$VERSION" >> $GITHUB_OUTPUT
          echo "üìå Version: $VERSION"

      - name: Check if tag exists
        id: check_tag
        run: |
          if git rev-parse "v${{ steps.version.outputs.version }}" >/dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è  Tag v${{ steps.version.outputs.version }} already exists"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "‚úÖ Tag v${{ steps.version.outputs.version }} does not exist"
          fi

      - name: Get previous tag
        id: prev_tag
        run: |
          if [ -n "${{ inputs.previous_tag }}" ]; then
            PREV_TAG="${{ inputs.previous_tag }}"
          else
            PREV_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          fi
          echo "tag=$PREV_TAG" >> $GITHUB_OUTPUT
          echo "üìå Previous tag: $PREV_TAG"

      - name: Get commit diff
        id: diff
        run: |
          if [ -n "${{ steps.prev_tag.outputs.tag }}" ]; then
            COMMITS=$(git log ${{ steps.prev_tag.outputs.tag }}..HEAD --pretty=format:"- %s" --no-merges | head -50)
            FILES_CHANGED=$(git diff --name-only ${{ steps.prev_tag.outputs.tag }}..HEAD | head -30)
          else
            COMMITS=$(git log --pretty=format:"- %s" --no-merges -20)
            FILES_CHANGED=$(git diff --name-only HEAD~20..HEAD 2>/dev/null | head -30)
          fi

          # Save to files for fallback
          echo "$COMMITS" > /tmp/commits.txt
          echo "$FILES_CHANGED" > /tmp/files.txt

          # Output commits for Copilot action
          echo "commits<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMITS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          # Output for debugging
          echo "üìù Recent commits:"
          echo "$COMMITS"

      - name: Generate release summary with GitHub Copilot
        id: summary
        uses: github/copilot-models-action@v1
        with:
          model: gpt-4o
          prompt: |
            You are a release notes writer for a Ghost blog theme called "Attegi".
            Based on the git commits below, generate a concise release summary.

            Commits:
            ${{ steps.diff.outputs.commits }}

            Requirements:
            - Group into: ‚ú® New Features, üêõ Bug Fixes, üé® Improvements, üìù Documentation
            - Only include categories with changes
            - Keep each item to 1 line
            - Maximum 10 items
            - No code fences
            - If minimal changes, write "Minor updates and improvements"

      - name: Fallback summary
        id: fallback
        if: failure() || steps.summary.outputs.response == ''
        run: |
          # Generate simple summary from commits
          COMMITS=$(cat /tmp/commits.txt | head -10)

          # Categorize commits
          FEATURES=$(echo "$COMMITS" | grep -iE "^- (feat|add|new)" | head -5 || true)
          FIXES=$(echo "$COMMITS" | grep -iE "^- (fix|bug|patch)" | head -3 || true)
          IMPROVEMENTS=$(echo "$COMMITS" | grep -iE "^- (improve|update|refactor|enhance|style)" | head -3 || true)
          DOCS=$(echo "$COMMITS" | grep -iE "^- (doc|readme)" | head -2 || true)

          SUMMARY=""
          if [ -n "$FEATURES" ]; then
            SUMMARY="${SUMMARY}#### ‚ú® New Features\n${FEATURES}\n\n"
          fi
          if [ -n "$FIXES" ]; then
            SUMMARY="${SUMMARY}#### üêõ Bug Fixes\n${FIXES}\n\n"
          fi
          if [ -n "$IMPROVEMENTS" ]; then
            SUMMARY="${SUMMARY}#### üé® Improvements\n${IMPROVEMENTS}\n\n"
          fi
          if [ -n "$DOCS" ]; then
            SUMMARY="${SUMMARY}#### üìù Documentation\n${DOCS}\n\n"
          fi

          if [ -z "$SUMMARY" ]; then
            SUMMARY="Minor updates and improvements"
          fi

          echo "response<<EOF" >> $GITHUB_OUTPUT
          echo -e "$SUMMARY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Build and package
        run: |
          npx grunt clean:dist
          npx grunt build
          npx grunt compress

      - name: Validate theme
        run: npx gscan -z dist/attegi.zip

      - name: Extract package info
        id: package
        run: |
          NAME=$(node -p "require('./package.json').name")
          DESCRIPTION=$(node -p "require('./package.json').description")
          DEMO=$(node -p "require('./package.json').demo")
          GHOST_VERSION=$(node -p "require('./package.json').engines.ghost")
          SIZE_BYTES=$(stat -f%z dist/attegi.zip 2>/dev/null || stat -c%s dist/attegi.zip)
          SIZE_KB=$((SIZE_BYTES / 1024))
          echo "name=$NAME" >> $GITHUB_OUTPUT
          echo "description=$DESCRIPTION" >> $GITHUB_OUTPUT
          echo "demo=$DEMO" >> $GITHUB_OUTPUT
          echo "ghost_version=$GHOST_VERSION" >> $GITHUB_OUTPUT
          echo "size_kb=${SIZE_KB}KB" >> $GITHUB_OUTPUT

      - name: Create and push tag
        if: steps.check_tag.outputs.exists == 'false'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "${{ steps.version.outputs.tag }}" -m "Release ${{ steps.version.outputs.tag }}"
          git push origin "${{ steps.version.outputs.tag }}"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: ${{ steps.package.outputs.name }} ${{ steps.version.outputs.tag }}
          generate_release_notes: true
          draft: false
          prerelease: false
          files: dist/attegi.zip
          body: |
            ## üé® ${{ steps.package.outputs.name }} ${{ steps.version.outputs.tag }}

            ${{ steps.package.outputs.description }}

            ### üìù What's Changed

            ${{ steps.summary.outputs.response || steps.fallback.outputs.response || 'See commits below for details.' }}

            ### üì• Installation

            1. **Download** `attegi.zip` from the assets below
            2. **Navigate** to Ghost Admin ‚Üí Settings ‚Üí Design
            3. **Upload** the theme zip file
            4. **Activate** the Attegi theme

            ### üîó Links

            - **Live Demo**: ${{ steps.package.outputs.demo }}
            - **Documentation**: [README.md](https://github.com/${{ github.repository }}/blob/main/README.md)
            - **‰∏≠ÊñáÊñáÊ°£**: [README_zh.md](https://github.com/${{ github.repository }}/blob/main/README_zh.md)

            ### üìä Package Info

            | Item | Value |
            |------|-------|
            | Size | ${{ steps.package.outputs.size_kb }} |
            | Ghost Version | ${{ steps.package.outputs.ghost_version }} |
            | Validation | ‚úÖ Passed GScan |
            | License | MIT |

            ---
            *Release notes generated with GitHub Copilot*
