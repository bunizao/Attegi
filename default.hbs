<!DOCTYPE html>
<html lang="{{@site.locale}}" class="{{#is "home"}}{{#if @site.cover_image}}cover-active{{/if}}{{/is}} {{{block "html_class"}}}">
<head>

	{{!-- Document Settings --}}
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />

	{{!-- Base Meta --}}
	<title>{{meta_title}}</title>
	<meta name="HandheldFriendly" content="True" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />

	{{!-- Resource Hints --}}
	{{!-- Preconnect to external CDNs used by Ghost and theme --}}
	<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin />
	<link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin />
	<link rel="dns-prefetch" href="https://cdn.jsdelivr.net" />
	<link rel="dns-prefetch" href="https://cdnjs.cloudflare.com" />
	{{!-- Preload critical CSS to reduce render-blocking --}}
	<link rel="preload" href="{{asset "css/style.css"}}" as="style" />
	{{!-- Note: GLightbox is NOT preloaded here, it's loaded conditionally only when images exist --}}

		<script>
			// Preload theme class ASAP to avoid light flash
			(function instantTheme() {
				var docEl = document.documentElement;
				var customScheme = '{{@custom.color_scheme}}';
				var mql = window.matchMedia ? window.matchMedia('(prefers-color-scheme: dark)') : null;

				function applyTheme(choice) {
					docEl.classList.remove('theme-dark', 'theme-light');
					if (choice === 'dark') {
						docEl.classList.add('theme-dark');
					} else if (choice === 'light') {
						docEl.classList.add('theme-light');
					} else if (choice === 'system') {
						if (mql && mql.matches) {
							docEl.classList.add('theme-dark');
						} else {
							docEl.classList.add('theme-light');
						}
					}
				}

				var stored = localStorage.getItem('attegi_theme') || (customScheme ? customScheme.toLowerCase() : 'system') || 'system';
				applyTheme(stored);

				if (mql && mql.addEventListener) {
					mql.addEventListener('change', function () {
						if ((localStorage.getItem('attegi_theme') || 'system') === 'system') {
							applyTheme('system');
						}
					});
				} else if (mql && mql.addListener) {
					mql.addListener(function () {
						if ((localStorage.getItem('attegi_theme') || 'system') === 'system') {
							applyTheme('system');
						}
					});
				}
			})();
		</script>

	{{!-- Critical CSS - Inlined for faster FCP and reduced CLS --}}
	<style>
		/* Critical layout styles to prevent CLS */
		html{font-size:62.5%}
		body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI','Microsoft YaHei',sans-serif;margin:0;background:var(--color-background-main,#fff)}
		img{max-width:100%;height:auto}
		.nav-header{position:absolute;top:0;left:0;width:100%;z-index:400}
		.nav-header .logo img{width:auto;height:4rem}
		.post-meta-avatar{width:3.6rem;height:3.6rem;flex-shrink:0}
		.blog-cover,.post-cover{contain:layout style paint;contain-intrinsic-size:100vw 50vh}
		.kg-bookmark-thumbnail{aspect-ratio:1.2/1;min-height:160px}
		.kg-embed-card iframe[src*="youtube"],.kg-embed-card iframe[src*="vimeo"]{aspect-ratio:16/9;width:100%;height:auto}
		/* Link styles */
		a.nav-menu,
		a.nav-search,
		.post-meta-author a,
		.post-meta-avatars a {
			color: inherit;
			text-decoration: none;
			-webkit-tap-highlight-color: transparent;
		}
		a.nav-menu:link,
		a.nav-menu:visited,
		a.nav-search:link,
		a.nav-search:visited,
		.post-meta-author a:link,
		.post-meta-author a:visited,
		.post-meta-avatars a:link,
		.post-meta-avatars a:visited {
			color: inherit;
			text-decoration: none;
		}
		/* Skeleton loading animation */
		.skeleton{background:linear-gradient(90deg,#f0f0f0 25%,#e0e0e0 50%,#f0f0f0 75%);background-size:200% 100%;animation:skeleton-loading 1.5s ease-in-out infinite;border-radius:4px}
		@keyframes skeleton-loading{0%{background-position:200% 0}100%{background-position:-200% 0}}
	</style>
	<link rel="stylesheet" href="{{asset "css/style.css"}}" />
	<script>
		/* Avoid noisy analytics calls in local/dev */
		(function () {
			var isLocal = /localhost|127\.0\.0\.1/.test(location.hostname);
			if (!isLocal) return;
			var nativeSendBeacon = navigator.sendBeacon ? navigator.sendBeacon.bind(navigator) : null;
			navigator.sendBeacon = function (url, data) {
				if (typeof url === 'string' && url.indexOf('google-analytics.com') !== -1) return true;
				return nativeSendBeacon ? nativeSendBeacon(url, data) : false;
			};
			if (window.fetch) {
				var origFetch = window.fetch.bind(window);
				window.fetch = function (input, init) {
					var url = (typeof input === 'string') ? input : (input && input.url);
					if (url && url.indexOf('google-analytics.com') !== -1) {
						return Promise.resolve(new Response('', { status: 204, statusText: 'blocked' }));
					}
					return origFetch(input, init);
				};
			}
		})();
	</script>

	<script>
			var siteUrl = '{{@site.url}}';
	</script>

	{{#match @custom.color_scheme "Dark"}}
		<script>
			if (!localStorage.getItem('attegi_theme')) {
				localStorage.setItem('attegi_theme', 'dark');
				document.documentElement.classList.add('theme-dark');
			}
		</script>
		<style>.js-theme {display:none!important;}</style>
	{{/match}}

	{{#match @custom.color_scheme "Light"}}
		<script>
			if (!localStorage.getItem('attegi_theme')) {
				localStorage.setItem('attegi_theme', 'light');
				document.documentElement.classList.add('theme-light');
			}
		</script>
		<style>.js-theme {display:none!important;}</style>
	{{/match}}

	{{#match @custom.color_scheme "System"}}
		<script>
			if (!localStorage.getItem('attegi_theme')) {
				localStorage.setItem('attegi_theme', 'system');
				document.documentElement.classList.remove('theme-dark', 'theme-light');
			}
		</script>
	{{/match}}

	{{#match @custom.color_scheme "!=" "Light"}}
		{{#if @custom.darkmode_accent_color}}
			<style>
				.theme-dark:root {
				  --ghost-accent-color: {{@custom.darkmode_accent_color}};
				}
				@media (prefers-color-scheme: dark) {
				  html:not(.theme-light):root {
				    --ghost-accent-color: {{@custom.darkmode_accent_color}};
				  }
				}
			</style>
		{{/if}}
	{{/match}}

	{{ghost_head}}

	{{!-- Optional OG image service override (post/page/tag/author) --}}
	{{!-- Note: Ghost outputs og:image before this, Cloudflare Worker removes duplicates --}}
	{{!-- Using format="jpeg" to ensure compatibility with @vercel/og (WebP not supported) --}}
	{{#if @custom.og_service_url}}
		{{#is "post"}}
			{{#post}}
				<meta property="og:image" content="{{@custom.og_service_url}}?title={{encode title}}&site={{encode @site.title}}{{#if custom_excerpt}}&excerpt={{encode (truncate custom_excerpt 150)}}{{else}}{{#if excerpt}}&excerpt={{encode (truncate excerpt 150)}}{{/if}}{{/if}}{{#if primary_author}}&author={{encode primary_author.name}}{{#if primary_author.profile_image}}&avatar={{encode (img_url primary_author.profile_image size="s" format="jpeg" absolute="true")}}{{/if}}{{/if}}{{#if primary_tag}}&tag={{encode primary_tag.name}}{{/if}}&date={{encode (date format="YYYY-MM-DD")}}&reading={{encode (reading_time)}}{{#if feature_image}}&image={{encode (img_url feature_image size="l" format="jpeg" absolute="true")}}{{/if}}{{#if @site.icon}}&icon={{encode @site.icon}}{{/if}}{{#if @custom.og_service_theme}}&theme={{encode @custom.og_service_theme}}{{/if}}">
				<meta name="twitter:image" content="{{@custom.og_service_url}}?title={{encode title}}&site={{encode @site.title}}{{#if custom_excerpt}}&excerpt={{encode (truncate custom_excerpt 150)}}{{else}}{{#if excerpt}}&excerpt={{encode (truncate excerpt 150)}}{{/if}}{{/if}}{{#if primary_author}}&author={{encode primary_author.name}}{{#if primary_author.profile_image}}&avatar={{encode (img_url primary_author.profile_image size="s" format="jpeg" absolute="true")}}{{/if}}{{/if}}{{#if primary_tag}}&tag={{encode primary_tag.name}}{{/if}}&date={{encode (date format="YYYY-MM-DD")}}&reading={{encode (reading_time)}}{{#if feature_image}}&image={{encode (img_url feature_image size="l" format="jpeg" absolute="true")}}{{/if}}{{#if @site.icon}}&icon={{encode @site.icon}}{{/if}}{{#if @custom.og_service_theme}}&theme={{encode @custom.og_service_theme}}{{/if}}">
			{{/post}}
		{{/is}}
		{{#is "page"}}
			{{#post}}
				<meta property="og:image" content="{{@custom.og_service_url}}?title={{encode title}}&site={{encode @site.title}}{{#if custom_excerpt}}&excerpt={{encode (truncate custom_excerpt 150)}}{{else}}{{#if excerpt}}&excerpt={{encode (truncate excerpt 150)}}{{/if}}{{/if}}{{#if primary_author}}&author={{encode primary_author.name}}{{#if primary_author.profile_image}}&avatar={{encode (img_url primary_author.profile_image size="s" format="jpeg" absolute="true")}}{{/if}}{{/if}}{{#if primary_tag}}&tag={{encode primary_tag.name}}{{/if}}&date={{encode (date format="YYYY-MM-DD")}}&reading={{encode (reading_time)}}{{#if feature_image}}&image={{encode (img_url feature_image size="l" format="jpeg" absolute="true")}}{{/if}}{{#if @site.icon}}&icon={{encode @site.icon}}{{/if}}{{#if @custom.og_service_theme}}&theme={{encode @custom.og_service_theme}}{{/if}}">
				<meta name="twitter:image" content="{{@custom.og_service_url}}?title={{encode title}}&site={{encode @site.title}}{{#if custom_excerpt}}&excerpt={{encode (truncate custom_excerpt 150)}}{{else}}{{#if excerpt}}&excerpt={{encode (truncate excerpt 150)}}{{/if}}{{/if}}{{#if primary_author}}&author={{encode primary_author.name}}{{#if primary_author.profile_image}}&avatar={{encode (img_url primary_author.profile_image size="s" format="jpeg" absolute="true")}}{{/if}}{{/if}}{{#if primary_tag}}&tag={{encode primary_tag.name}}{{/if}}&date={{encode (date format="YYYY-MM-DD")}}&reading={{encode (reading_time)}}{{#if feature_image}}&image={{encode (img_url feature_image size="l" format="jpeg" absolute="true")}}{{/if}}{{#if @site.icon}}&icon={{encode @site.icon}}{{/if}}{{#if @custom.og_service_theme}}&theme={{encode @custom.og_service_theme}}{{/if}}">
			{{/post}}
		{{/is}}
		{{#is "tag"}}
			<meta property="og:image" content="{{@custom.og_service_url}}?title={{encode tag.name}}&site={{encode @site.title}}{{#if tag.description}}&excerpt={{encode (truncate tag.description 150)}}{{/if}}&tag={{encode tag.name}}{{#if tag.feature_image}}&image={{encode (img_url tag.feature_image size="l" format="jpeg" absolute="true")}}{{/if}}{{#if @site.icon}}&icon={{encode @site.icon}}{{/if}}{{#if @custom.og_service_theme}}&theme={{encode @custom.og_service_theme}}{{/if}}">
			<meta name="twitter:image" content="{{@custom.og_service_url}}?title={{encode tag.name}}&site={{encode @site.title}}{{#if tag.description}}&excerpt={{encode (truncate tag.description 150)}}{{/if}}&tag={{encode tag.name}}{{#if tag.feature_image}}&image={{encode (img_url tag.feature_image size="l" format="jpeg" absolute="true")}}{{/if}}{{#if @site.icon}}&icon={{encode @site.icon}}{{/if}}{{#if @custom.og_service_theme}}&theme={{encode @custom.og_service_theme}}{{/if}}">
		{{/is}}
		{{#is "author"}}
			{{#primary_author}}
				<meta property="og:image" content="{{@custom.og_service_url}}?title={{encode name}}&site={{encode @site.title}}{{#if bio}}&excerpt={{encode (truncate bio 150)}}{{/if}}&author={{encode name}}{{#if profile_image}}&avatar={{encode (img_url profile_image size="s" format="jpeg" absolute="true")}}{{/if}}{{#if cover_image}}&image={{encode (img_url cover_image size="l" format="jpeg" absolute="true")}}{{else}}{{#if profile_image}}&image={{encode (img_url profile_image size="s" format="jpeg" absolute="true")}}{{/if}}{{/if}}{{#if @site.icon}}&icon={{encode @site.icon}}{{/if}}{{#if @custom.og_service_theme}}&theme={{encode @custom.og_service_theme}}{{/if}}">
				<meta name="twitter:image" content="{{@custom.og_service_url}}?title={{encode name}}&site={{encode @site.title}}{{#if bio}}&excerpt={{encode (truncate bio 150)}}{{/if}}&author={{encode name}}{{#if profile_image}}&avatar={{encode (img_url profile_image size="s" format="jpeg" absolute="true")}}{{/if}}{{#if cover_image}}&image={{encode (img_url cover_image size="l" format="jpeg" absolute="true")}}{{else}}{{#if profile_image}}&image={{encode (img_url profile_image size="s" format="jpeg" absolute="true")}}{{/if}}{{/if}}{{#if @site.icon}}&icon={{encode @site.icon}}{{/if}}{{#if @custom.og_service_theme}}&theme={{encode @custom.og_service_theme}}{{/if}}">
			{{/primary_author}}
		{{/is}}
	{{/if}}
</head>

<body class="{{body_class}}">

	<div class="viewport">
			<div class="nav-header">
				<nav class="nav-wrapper" aria-label="{{t "Main"}}">
					{{#if @site.logo}}
						<span class="logo">
							<a href="{{@site.url}}" title="{{t "Home"}}"><img src="{{@site.logo}}" alt="{{t "Logo"}}" /></a>
						</span>
					{{/if}}
					{{navigation}}
					<a class="nav-search" href="#search" role="button" aria-label="{{t "Search"}}" data-ghost-search><i class="icon icon-search" aria-hidden="true">{{> "icons/icon-search"}}</i></a>
					{{#if @site.members_enabled}}
						<span class="nav-members">
							{{#unless @member}}
								{{#unless @site.members_invite_only}}
									<a class="nav-button-secondary" href="#/portal/signin" data-portal="signin">{{t "Sign in"}}</a>
								{{#unless hideSubscribeButton}}
									<a class="nav-button-primary" href="#/portal/signup" data-portal="signup">{{t "Subscribe"}}</a>
								{{/unless}}
							{{else}}
								<a class="nav-button-primary" href="#/portal/signin" data-portal="signin">{{t "Sign in"}}</a>
							{{/unless}}
						{{else}}
							<a class="nav-button-secondary" href="#/portal/account" data-portal="account">{{t "Account"}}</a>
						{{/unless}}
					</span>
				{{/if}}
			</nav>

				<div class="nav-wrapper-control">
					<div class="inner">
						<a class="nav-menu" href="#menu" role="button" aria-expanded="false"><i class="icon icon-menu" aria-hidden="true">{{> "icons/icon-menu"}}</i> {{t "Menu"}}</a>
						<a class="nav-search" href="#search" role="button" aria-label="{{t "Search"}}" data-ghost-search><i class="icon icon-search" aria-hidden="true">{{> "icons/icon-search"}}</i></a>
					</div>
				</div>
			</div>
			<div class="nav-close" role="button" aria-label="{{t "Close"}}" tabindex="0" aria-hidden="true"></div>

		<section class="page-wrapper">

			{{{body}}}

			<footer class="nav-footer">
				<div class="footer-main">
					{{!-- Left: Copyright --}}
					<div class="footer-left">
						<span class="footer-copyright">&copy; {{date format='YYYY'}} {{@site.title}}</span>
						<span class="footer-credits">Published with <a href="https://ghost.org">Ghost</a> & <a href="https://github.com/bunizao/attegi">Attegi</a></span>
					</div>

					{{!-- Center: Custom text (supports HTML) --}}
					{{#if @custom.footer_text}}
					<div class="footer-center">
						<span class="footer-custom-text">{{{@custom.footer_text}}}</span>
					</div>
					{{/if}}

					{{!-- Right: Social + Theme toggle --}}
					<div class="footer-right">
						<div class="footer-social">
							<a class="social-link" aria-label="RSS" href="{{@site.url}}/rss/" title="RSS">
								<i class="icon icon-rss" aria-hidden="true">{{> "icons/icon-rss"}}</i>
							</a>
							{{#if @site.twitter}}<a class="social-link" aria-label="X" href="{{social_url type='twitter'}}" title="X" target="_blank" rel="noopener">
								<i class="icon icon-twitter" aria-hidden="true">{{> "icons/icon-twitter"}}</i>
							</a>{{/if}}
							{{#if @site.facebook}}<a class="social-link" aria-label="Facebook" href="{{social_url type='facebook'}}" title="Facebook" target="_blank" rel="noopener">
								<i class="icon icon-facebook" aria-hidden="true">{{> "icons/icon-facebook"}}</i>
							</a>{{/if}}
							{{#if @custom.instagram_url}}<a class="social-link" aria-label="Instagram" href="{{@custom.instagram_url}}" title="Instagram" target="_blank" rel="noopener">
								<i class="icon icon-instagram" aria-hidden="true">{{> "icons/icon-instagram"}}</i>
							</a>{{/if}}
							{{#if @custom.github_url}}<a class="social-link" aria-label="GitHub" href="{{@custom.github_url}}" title="GitHub" target="_blank" rel="noopener">
								<i class="icon icon-github" aria-hidden="true">{{> "icons/icon-github"}}</i>
							</a>{{/if}}
						</div>
						<span class="footer-divider"></span>
						<button class="theme-toggle js-theme" aria-label="{{t "Toggle theme"}}" data-system="System" data-dark="Dark" data-light="Light">
							<i class="icon theme-icon-sun" aria-hidden="true">{{> "icons/icon-sun"}}</i>
							<i class="icon theme-icon-moon" aria-hidden="true">{{> "icons/icon-moon"}}</i>
							<i class="icon theme-icon-monitor" aria-hidden="true">{{> "icons/icon-monitor"}}</i>
						</button>
					</div>
				</div>
			</footer>

		</section>
	</div>

	<svg class="liquid-glass-filter" aria-hidden="true" focusable="false" width="0" height="0" style="position:absolute;overflow:hidden">
		<defs>
			<!-- Liquid glass filter with displacement for curving effect -->
			<filter id="liquid-glass" x="-50%" y="-50%" width="200%" height="200%">
				<!-- Generate organic noise pattern for displacement -->
				<feTurbulence type="fractalNoise" baseFrequency="0.015" numOctaves="3" seed="5" result="noise" />
				<!-- Soften the noise -->
				<feGaussianBlur in="noise" stdDeviation="1.5" result="softNoise" />
				<!-- Blur source for glass effect -->
				<feGaussianBlur in="SourceGraphic" stdDeviation="8" result="blur" />
				<!-- Apply displacement for liquid warping -->
				<feDisplacementMap in="blur" in2="softNoise" scale="25" xChannelSelector="R" yChannelSelector="G" result="displaced" />
				<!-- Boost saturation slightly -->
				<feColorMatrix in="displaced" type="saturate" values="1.15" />
			</filter>
			<!-- Simple frosted blur fallback -->
			<filter id="frosted" x="-50%" y="-50%" width="200%" height="200%">
				<feGaussianBlur in="SourceGraphic" stdDeviation="12" result="blur" />
				<feColorMatrix in="blur" type="saturate" values="1.2" />
			</filter>
		</defs>
	</svg>

	{{!-- Load basic scripts (no defer, placed before </body> for reliability) --}}
	<script src="{{asset "js/script.js"}}"></script>
	<script>
		// Conditionally load GLightbox only if images exist
		(function() {
			function initGLightbox() {
				var galleryImages = document.querySelectorAll('.kg-gallery-image img, .kg-image-card img');
				if (galleryImages.length === 0) return; // No images, skip loading

				// Load CSS
				var css = document.createElement('link');
				css.rel = 'stylesheet';
				css.href = 'https://cdnjs.cloudflare.com/ajax/libs/glightbox/3.3.0/css/glightbox.min.css';
				document.head.appendChild(css);

				// Wrap images
				galleryImages.forEach(function(img) {
					if (!img.closest('a')) {
						var wrapper = document.createElement('a');
						wrapper.href = img.src;
						wrapper.classList.add('glightbox');
						wrapper.setAttribute('data-gallery', img.closest('.kg-gallery-card') ? 'gallery' : 'images');
						img.parentNode.insertBefore(wrapper, img);
						wrapper.appendChild(img);
					}
				});

				// Load JS
				var script = document.createElement('script');
				script.src = 'https://cdnjs.cloudflare.com/ajax/libs/glightbox/3.3.0/js/glightbox.min.js';
				script.onload = function() {
					if (typeof GLightbox !== 'undefined') {
						GLightbox({
							selector: '.glightbox',
							touchNavigation: true,
							loop: true,
							closeOnOutsideClick: true,
							openEffect: 'fade',
							closeEffect: 'fade',
							zoomable: true,
							draggable: true,
							dragAutoSnap: true,
							preload: true
						});
					}
				};
				document.body.appendChild(script);
			}

			if (document.readyState === 'loading') {
				document.addEventListener('DOMContentLoaded', initGLightbox);
			} else {
				initGLightbox();
			}
		})();
	</script>

	{{!-- The #block helper will pull in data from the #contentFor other template files. In this case, there's some JavaScript which we only want to use in post.hbs, but it needs to be included down here, after jQuery has already loaded. --}}
	{{{block "scripts"}}}

	{{!-- Ghost outputs important scripts and data with this tag - it should always be the very last thing before the closing body tag --}}
	{{ghost_foot}}

</body>
</html>
