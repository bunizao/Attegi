<!DOCTYPE html>
<html lang="{{@site.locale}}" class="{{#is "home"}}{{#if @site.cover_image}}cover-active{{/if}}{{/is}} {{{block "html_class"}}}">
<head>

	{{!-- Document Settings --}}
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />

	{{!-- Base Meta --}}
	<title>{{meta_title}}</title>
	<meta name="HandheldFriendly" content="True" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />

	{{!-- Resource Hints --}}
	<link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin />
	<link rel="dns-prefetch" href="https://cdnjs.cloudflare.com" />
	{{!-- Note: GLightbox is NOT preloaded here, it's loaded conditionally only when images exist --}}

		<script>
			// Preload theme class ASAP to avoid light flash
			(function instantTheme() {
				var docEl = document.documentElement;
				var customScheme = '{{@custom.color_scheme}}';
				var mql = window.matchMedia ? window.matchMedia('(prefers-color-scheme: dark)') : null;

				function applyTheme(choice) {
					docEl.classList.remove('theme-dark', 'theme-light');
					if (choice === 'dark') {
						docEl.classList.add('theme-dark');
					} else if (choice === 'light') {
						docEl.classList.add('theme-light');
					} else if (choice === 'system') {
						if (mql && mql.matches) {
							docEl.classList.add('theme-dark');
						} else {
							docEl.classList.add('theme-light');
						}
					}
				}

				var stored = localStorage.getItem('attegi_theme') || (customScheme ? customScheme.toLowerCase() : 'system') || 'system';
				applyTheme(stored);

				if (mql && mql.addEventListener) {
					mql.addEventListener('change', function () {
						if ((localStorage.getItem('attegi_theme') || 'system') === 'system') {
							applyTheme('system');
						}
					});
				} else if (mql && mql.addListener) {
					mql.addListener(function () {
						if ((localStorage.getItem('attegi_theme') || 'system') === 'system') {
							applyTheme('system');
						}
					});
				}
			})();
		</script>

	{{!-- Styles'n'Scripts --}}
	<style>
		a.nav-menu,
		a.nav-search,
		.post-meta-author a,
		.post-meta-avatars a {
			color: inherit;
			text-decoration: none;
			-webkit-tap-highlight-color: transparent;
		}
		a.nav-menu:link,
		a.nav-menu:visited,
		a.nav-search:link,
		a.nav-search:visited,
		.post-meta-author a:link,
		.post-meta-author a:visited,
		.post-meta-avatars a:link,
		.post-meta-avatars a:visited {
			color: inherit;
			text-decoration: none;
		}
	</style>
	<link rel="stylesheet" href="{{asset "css/style.css"}}" />
	<script>
		/* Avoid noisy analytics calls in local/dev */
		(function () {
			var isLocal = /localhost|127\.0\.0\.1/.test(location.hostname);
			if (!isLocal) return;
			var nativeSendBeacon = navigator.sendBeacon ? navigator.sendBeacon.bind(navigator) : null;
			navigator.sendBeacon = function (url, data) {
				if (typeof url === 'string' && url.indexOf('google-analytics.com') !== -1) return true;
				return nativeSendBeacon ? nativeSendBeacon(url, data) : false;
			};
			if (window.fetch) {
				var origFetch = window.fetch.bind(window);
				window.fetch = function (input, init) {
					var url = (typeof input === 'string') ? input : (input && input.url);
					if (url && url.indexOf('google-analytics.com') !== -1) {
						return Promise.resolve(new Response('', { status: 204, statusText: 'blocked' }));
					}
					return origFetch(input, init);
				};
			}
		})();
	</script>

	<script>
			var siteUrl = '{{@site.url}}';
	</script>

	{{#match @custom.color_scheme "Dark"}}
		<script>
			if (!localStorage.getItem('attegi_theme')) {
				localStorage.setItem('attegi_theme', 'dark');
				document.documentElement.classList.add('theme-dark');
			}
		</script>
		<style>.js-theme {display:none!important;}</style>
	{{/match}}

	{{#match @custom.color_scheme "Light"}}
		<script>
			if (!localStorage.getItem('attegi_theme')) {
				localStorage.setItem('attegi_theme', 'light');
				document.documentElement.classList.add('theme-light');
			}
		</script>
		<style>.js-theme {display:none!important;}</style>
	{{/match}}

	{{#match @custom.color_scheme "System"}}
		<script>
			if (!localStorage.getItem('attegi_theme')) {
				localStorage.setItem('attegi_theme', 'system');
				document.documentElement.classList.remove('theme-dark', 'theme-light');
			}
		</script>
	{{/match}}

	{{#match @custom.color_scheme "!=" "Light"}}
		{{#if @custom.darkmode_accent_color}}
			<style>
				.theme-dark:root {
				  --ghost-accent-color: {{@custom.darkmode_accent_color}};
				}
				@media (prefers-color-scheme: dark) {
				  html:not(.theme-light):root {
				    --ghost-accent-color: {{@custom.darkmode_accent_color}};
				  }
				}
			</style>
		{{/if}}
	{{/match}}

	{{ghost_head}}
</head>

<body class="{{body_class}}">

	<div class="viewport">
			<div class="nav-header">
				<nav class="nav-wrapper" aria-label="{{t "Main"}}">
					{{#if @site.logo}}
						<span class="logo">
							<a href="{{@site.url}}" title="{{t "Home"}}"><img src="{{@site.logo}}" alt="{{t "Logo"}}" /></a>
						</span>
					{{/if}}
					{{navigation}}
					<a class="nav-search" href="#search" role="button" aria-label="{{t "Search"}}" data-ghost-search><i class="icon icon-search" aria-hidden="true">{{> "icons/icon-search"}}</i></a>
					{{#if @site.members_enabled}}
						<span class="nav-members">
							{{#unless @member}}
								{{#unless @site.members_invite_only}}
									<a class="nav-button-secondary" href="#/portal/signin" data-portal="signin">{{t "Sign in"}}</a>
								{{#unless hideSubscribeButton}}
									<a class="nav-button-primary" href="#/portal/signup" data-portal="signup">{{t "Subscribe"}}</a>
								{{/unless}}
							{{else}}
								<a class="nav-button-primary" href="#/portal/signin" data-portal="signin">{{t "Sign in"}}</a>
							{{/unless}}
						{{else}}
							<a class="nav-button-secondary" href="#/portal/account" data-portal="account">{{t "Account"}}</a>
						{{/unless}}
					</span>
				{{/if}}
			</nav>

				<div class="nav-wrapper-control">
					<div class="inner">
						<a class="nav-menu" href="#menu" role="button" aria-expanded="false"><i class="icon icon-menu" aria-hidden="true">{{> "icons/icon-menu"}}</i> {{t "Menu"}}</a>
						<a class="nav-search" href="#search" role="button" aria-label="{{t "Search"}}" data-ghost-search><i class="icon icon-search" aria-hidden="true">{{> "icons/icon-search"}}</i></a>
					</div>
				</div>
			</div>
			<div class="nav-close" role="button" aria-label="{{t "Close"}}" tabindex="0" aria-hidden="true"></div>

		<section class="page-wrapper">

			{{{body}}}

			<div class="nav-footer">
				<nav class="nav-wrapper" aria-label="{{t "Footer"}}">
					<span class="nav-copy">
						
						<span class="nav-title">{{@site.title}} &copy; {{date format='YYYY'}}</span>
						<a aria-label="RSS" href="{{@site.url}}/rss/" title="RSS"><i class="icon icon-rss" aria-hidden="true">{{> "icons/icon-rss"}}</i></a>
						{{#if @site.twitter}}<a aria-label="Twitter" href="{{social_url type='twitter'}}" title="{{@site.twitter}}"><i class="icon icon-twitter" aria-hidden="true">{{> "icons/icon-twitter"}}</i></a>{{/if}}
						{{#if @site.facebook}}<a aria-label="Facebook" href="{{social_url type='facebook'}}" title="{{@site.facebook}}"><i class="icon icon-facebook" aria-hidden="true">{{> "icons/icon-facebook"}}</i></a>{{/if}}
					</span>
					{{#if @site.secondary_navigation}}
					{{navigation type="secondary"}}
					{{/if}}
					<span class="nav-credits">{{t "Published with"}} <a href="https://ghost.org">Ghost</a> &bull; {{t "Theme" }} <a href="https://github.com/bunizao/attegi">Attegi</a> &bull; <a class="menu-item js-theme" href="#" data-system="System" data-dark="Dark" data-light="Light"><span class="theme-icon"></span><span class="theme-text">System</span> </a> </span>
				</nav>
			</div>

		</section>
	</div>

	<svg class="liquid-glass-filter" aria-hidden="true" focusable="false" width="0" height="0" style="position:absolute;overflow:hidden">
		<defs>
			<!-- Liquid glass filter with displacement for curving effect -->
			<filter id="liquid-glass" x="-50%" y="-50%" width="200%" height="200%">
				<!-- Generate organic noise pattern for displacement -->
				<feTurbulence type="fractalNoise" baseFrequency="0.015" numOctaves="3" seed="5" result="noise" />
				<!-- Soften the noise -->
				<feGaussianBlur in="noise" stdDeviation="1.5" result="softNoise" />
				<!-- Blur source for glass effect -->
				<feGaussianBlur in="SourceGraphic" stdDeviation="8" result="blur" />
				<!-- Apply displacement for liquid warping -->
				<feDisplacementMap in="blur" in2="softNoise" scale="25" xChannelSelector="R" yChannelSelector="G" result="displaced" />
				<!-- Boost saturation slightly -->
				<feColorMatrix in="displaced" type="saturate" values="1.15" />
			</filter>
			<!-- Simple frosted blur fallback -->
			<filter id="frosted" x="-50%" y="-50%" width="200%" height="200%">
				<feGaussianBlur in="SourceGraphic" stdDeviation="12" result="blur" />
				<feColorMatrix in="blur" type="saturate" values="1.2" />
			</filter>
		</defs>
	</svg>

	{{!-- Load basic scripts (no defer, placed before </body> for reliability) --}}
	<script src="{{asset "js/script.js"}}"></script>
	<script>
		// Conditionally load GLightbox only if images exist
		(function() {
			function initGLightbox() {
				var galleryImages = document.querySelectorAll('.kg-gallery-image img, .kg-image-card img');
				if (galleryImages.length === 0) return; // No images, skip loading

				// Load CSS
				var css = document.createElement('link');
				css.rel = 'stylesheet';
				css.href = 'https://cdnjs.cloudflare.com/ajax/libs/glightbox/3.3.0/css/glightbox.min.css';
				css.integrity = 'sha512-QLFZ4V6pN2B3ZGLgmJYh+/1phLz/+1qBbYJCZfV+K3+/5ZAH+eYwSM0Z5xvXvBgtW3qNzN+SzJPJ+FQ+rCsUXg==';
				css.crossOrigin = 'anonymous';
				document.head.appendChild(css);

				// Wrap images
				galleryImages.forEach(function(img) {
					if (!img.closest('a')) {
						var wrapper = document.createElement('a');
						wrapper.href = img.src;
						wrapper.classList.add('glightbox');
						wrapper.setAttribute('data-gallery', img.closest('.kg-gallery-card') ? 'gallery' : 'images');
						img.parentNode.insertBefore(wrapper, img);
						wrapper.appendChild(img);
					}
				});

				// Load JS
				var script = document.createElement('script');
				script.src = 'https://cdnjs.cloudflare.com/ajax/libs/glightbox/3.3.0/js/glightbox.min.js';
				script.integrity = 'sha512-RBWI5Qf647bcVhqbEnRoL4KuUT+Liz+oG5jtF+HP05Oa5088M9G0GxG0uoHR9Aws6RV39RWZJ1Mfey1lFNtRaQ==';
				script.crossOrigin = 'anonymous';
				script.onload = function() {
					if (typeof GLightbox !== 'undefined') {
						GLightbox({
							selector: '.glightbox',
							touchNavigation: true,
							loop: true,
							closeOnOutsideClick: true,
							openEffect: 'fade',
							closeEffect: 'fade',
							zoomable: true,
							draggable: true,
							dragAutoSnap: true,
							preload: true
						});
					}
				};
				document.body.appendChild(script);
			}

			if (document.readyState === 'loading') {
				document.addEventListener('DOMContentLoaded', initGLightbox);
			} else {
				initGLightbox();
			}
		})();
	</script>

	{{!-- The #block helper will pull in data from the #contentFor other template files. In this case, there's some JavaScript which we only want to use in post.hbs, but it needs to be included down here, after jQuery has already loaded. --}}
	{{{block "scripts"}}}

	{{!-- Capture Ghost portal URL for lazy loading --}}
	{{#if @site.members_enabled}}
	<script>
		// Intercept Ghost portal script injection for lazy loading
		(function() {
			var observer = new MutationObserver(function(mutations) {
				mutations.forEach(function(mutation) {
					mutation.addedNodes.forEach(function(node) {
						if (node.tagName === 'SCRIPT' && node.src && node.src.indexOf('portal') !== -1) {
							// Capture portal URL
							window.ghost = window.ghost || {};
							window.ghost.portal = node.src;
							// Remove the script to prevent auto-loading
							node.remove();
							// Stop observing once we found it
							observer.disconnect();
						}
					});
				});
			});
			observer.observe(document.documentElement, { childList: true, subtree: true });
		})();
	</script>
	{{/if}}

	{{!-- Ghost outputs important scripts and data with this tag - it should always be the very last thing before the closing body tag --}}
	{{ghost_foot}}

</body>
</html>
