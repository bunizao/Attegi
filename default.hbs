<!DOCTYPE html>
<html lang="{{@site.locale}}" class="{{#is "home"}}{{#if @site.cover_image}}cover-active{{/if}}{{/is}} {{{block "html_class"}}}">
<head>

	{{!-- Document Settings --}}
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />

	{{!-- Base Meta --}}
	<title>{{meta_title}}</title>
	<meta name="HandheldFriendly" content="True" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	{{{block "head"}}}

	{{!-- Resource Hints --}}
	{{!-- Preconnect to external CDNs used by Ghost and theme --}}
	<link rel="preconnect" href="https://fonts.googleapis.com" />
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
	<link rel="dns-prefetch" href="https://fonts.googleapis.com" />
	<link rel="dns-prefetch" href="https://fonts.gstatic.com" />
	{{!-- Preload critical CSS to reduce render-blocking --}}
	<link rel="preload" href="{{asset "css/style.css"}}" as="style" />
	{{!-- JetBrains Mono for code blocks --}}
	<link rel="preload" href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&display=swap" as="style" />
	<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&display=swap" />
	{{!-- Note: GLightbox is NOT preloaded here, it's loaded conditionally only when images exist --}}

		<script>
			// Preload theme class ASAP to avoid light flash
			(function instantTheme() {
				var docEl = document.documentElement;
				var customScheme = '{{@custom.color_scheme}}';
				var mql = window.matchMedia ? window.matchMedia('(prefers-color-scheme: dark)') : null;

				function applyTheme(choice) {
					docEl.classList.remove('theme-dark', 'theme-light');
					if (choice === 'dark') {
						docEl.classList.add('theme-dark');
					} else if (choice === 'light') {
						docEl.classList.add('theme-light');
					} else if (choice === 'system') {
						if (mql && mql.matches) {
							docEl.classList.add('theme-dark');
						} else {
							docEl.classList.add('theme-light');
						}
					}
				}

				var stored = localStorage.getItem('attegi_theme') || (customScheme ? customScheme.toLowerCase() : 'system') || 'system';
				applyTheme(stored);

				if (mql && mql.addEventListener) {
					mql.addEventListener('change', function () {
						if ((localStorage.getItem('attegi_theme') || 'system') === 'system') {
							applyTheme('system');
						}
					});
				} else if (mql && mql.addListener) {
					mql.addListener(function () {
						if ((localStorage.getItem('attegi_theme') || 'system') === 'system') {
							applyTheme('system');
						}
					});
				}
			})();
		</script>

	{{!-- Critical CSS - Inlined for faster FCP and reduced CLS --}}
	<style>
		/* Critical layout styles to prevent CLS */
		html{font-size:62.5%}
		body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI','Microsoft YaHei',sans-serif;margin:0;background:var(--color-background-main,#fff)}
		img{max-width:100%;height:auto}
		.nav-header{position:absolute;top:0;left:0;width:100%;z-index:400}
		.nav-header .logo img{width:auto;height:4rem}
		.post-meta-avatar{width:3.6rem;height:3.6rem;flex-shrink:0}
		.blog-cover,.post-cover{contain:layout style paint;contain-intrinsic-size:100vw 50vh}
		.kg-bookmark-thumbnail{aspect-ratio:1.2/1;min-height:160px}
		.kg-embed-card iframe[src*="youtube"],.kg-embed-card iframe[src*="vimeo"]{aspect-ratio:16/9;width:100%;height:auto}
		/* Link styles */
		a.nav-menu,
		a.nav-search,
		.post-meta-author a,
		.post-meta-avatars a {
			color: inherit;
			text-decoration: none;
			-webkit-tap-highlight-color: transparent;
		}
		a.nav-menu:link,
		a.nav-menu:visited,
		a.nav-search:link,
		a.nav-search:visited,
		.post-meta-author a:link,
		.post-meta-author a:visited,
		.post-meta-avatars a:link,
		.post-meta-avatars a:visited {
			color: inherit;
			text-decoration: none;
		}
		/* Skeleton loading animation */
		.skeleton{background:linear-gradient(90deg,#f0f0f0 25%,#e0e0e0 50%,#f0f0f0 75%);background-size:200% 100%;animation:skeleton-loading 1.5s ease-in-out infinite;border-radius:4px}
		@keyframes skeleton-loading{0%{background-position:200% 0}100%{background-position:-200% 0}}
	</style>
	<link rel="stylesheet" href="{{asset "css/style.css"}}" />
	<script>
		/* Avoid noisy analytics calls in local/dev */
		(function () {
			var isLocal = /localhost|127\.0\.0\.1/.test(location.hostname);
			if (!isLocal) return;

			function isAnalyticsHost(url) {
				try {
					var host = new URL(url, location.href).hostname;
					return host === 'google-analytics.com' || host.endsWith('.google-analytics.com');
				} catch (e) {
					return false;
				}
			}

			var nativeSendBeacon = navigator.sendBeacon ? navigator.sendBeacon.bind(navigator) : null;
			navigator.sendBeacon = function (url, data) {
				if (typeof url === 'string' && isAnalyticsHost(url)) return true;
				return nativeSendBeacon ? nativeSendBeacon(url, data) : false;
			};
			if (window.fetch) {
				var origFetch = window.fetch.bind(window);
				window.fetch = function (input, init) {
					var url = (typeof input === 'string') ? input : (input && input.url);
					if (url && isAnalyticsHost(url)) {
						return Promise.resolve(new Response('', { status: 204, statusText: 'blocked' }));
					}
					return origFetch(input, init);
				};
			}
		})();
	</script>

	<script>
			var siteUrl = '{{@site.url}}';
	</script>

	<script>
		(function () {
			var colorScheme = '{{@custom.color_scheme}}';
			var darkAccent = '{{@custom.darkmode_accent_color}}';
			var hasStored = !!localStorage.getItem('attegi_theme');

			if (!hasStored) {
				if (colorScheme === 'Dark') {
					localStorage.setItem('attegi_theme', 'dark');
					document.documentElement.classList.add('theme-dark');
				} else if (colorScheme === 'Light') {
					localStorage.setItem('attegi_theme', 'light');
					document.documentElement.classList.add('theme-light');
				} else if (colorScheme === 'System') {
					localStorage.setItem('attegi_theme', 'system');
					document.documentElement.classList.remove('theme-dark', 'theme-light');
				}
			}

			// Hide theme toggle if a fixed scheme is enforced
			if (colorScheme === 'Dark' || colorScheme === 'Light') {
				var hideThemeStyle = document.createElement('style');
				hideThemeStyle.textContent = '.js-theme {display:none!important;}';
				document.head.appendChild(hideThemeStyle);
			}

			// Apply dark accent color when not forcing Light
			if (darkAccent && colorScheme !== 'Light') {
				var accentStyle = document.createElement('style');
				accentStyle.textContent = `
					.theme-dark:root {
					  --ghost-accent-color: ${darkAccent};
					}
					@media (prefers-color-scheme: dark) {
					  html:not(.theme-light):root {
					    --ghost-accent-color: ${darkAccent};
					  }
					}
				`;
				document.head.appendChild(accentStyle);
			}
		})();
	</script>

	{{ghost_head}}

	{{!-- Optional OG image service override (post/page/tag/author) --}}
	{{!-- Note: Ghost outputs og:image before this, Cloudflare Worker removes duplicates --}}
	{{!-- Using format="jpeg" to ensure compatibility with @vercel/og (WebP not supported) --}}
	{{#if @custom.og_service_url}}
		{{#is "post"}}
			{{#post}}
				<meta property="og:image" content="{{@custom.og_service_url}}?title={{encode title}}&site={{encode @site.title}}{{#if excerpt}}&excerpt={{encode (excerpt characters="50")}}{{/if}}{{#if primary_author}}&author={{encode primary_author.name}}{{#if primary_author.profile_image}}&avatar={{encode (img_url primary_author.profile_image size="s" format="jpeg" absolute="true")}}{{/if}}{{/if}}{{#if primary_tag}}&tag={{encode primary_tag.name}}{{/if}}&date={{encode (date format="YYYY-MM-DD")}}&reading={{encode (reading_time)}}{{#if feature_image}}&image={{encode (img_url feature_image size="l" format="jpeg" absolute="true")}}{{/if}}{{#if @site.icon}}&icon={{encode (img_url @site.icon size="s" format="png" absolute="true")}}{{/if}}{{#if @custom.og_service_theme}}&theme={{encode @custom.og_service_theme}}{{/if}}{{#if updated_at}}&ts={{date updated_at format="x"}}{{/if}}">
				<meta property="og:image:width" content="1600">
				<meta property="og:image:height" content="840">
				<meta name="twitter:image" content="{{@custom.og_service_url}}?title={{encode title}}&site={{encode @site.title}}{{#if excerpt}}&excerpt={{encode (excerpt characters="50")}}{{/if}}{{#if primary_author}}&author={{encode primary_author.name}}{{#if primary_author.profile_image}}&avatar={{encode (img_url primary_author.profile_image size="s" format="jpeg" absolute="true")}}{{/if}}{{/if}}{{#if primary_tag}}&tag={{encode primary_tag.name}}{{/if}}&date={{encode (date format="YYYY-MM-DD")}}&reading={{encode (reading_time)}}{{#if feature_image}}&image={{encode (img_url feature_image size="l" format="jpeg" absolute="true")}}{{/if}}{{#if @site.icon}}&icon={{encode (img_url @site.icon size="s" format="png" absolute="true")}}{{/if}}{{#if @custom.og_service_theme}}&theme={{encode @custom.og_service_theme}}{{/if}}{{#if updated_at}}&ts={{date updated_at format="x"}}{{/if}}">
			{{/post}}
		{{/is}}
		{{#is "page"}}
			{{#post}}
				<meta property="og:image" content="{{@custom.og_service_url}}?title={{encode title}}&site={{encode @site.title}}{{#if excerpt}}&excerpt={{encode (excerpt characters="50")}}{{/if}}{{#if primary_author}}&author={{encode primary_author.name}}{{#if primary_author.profile_image}}&avatar={{encode (img_url primary_author.profile_image size="s" format="jpeg" absolute="true")}}{{/if}}{{/if}}{{#if primary_tag}}&tag={{encode primary_tag.name}}{{/if}}&date={{encode (date format="YYYY-MM-DD")}}&reading={{encode (reading_time)}}{{#if feature_image}}&image={{encode (img_url feature_image size="l" format="jpeg" absolute="true")}}{{/if}}{{#if @site.icon}}&icon={{encode (img_url @site.icon size="s" format="png" absolute="true")}}{{/if}}{{#if @custom.og_service_theme}}&theme={{encode @custom.og_service_theme}}{{/if}}{{#if updated_at}}&ts={{date updated_at format="x"}}{{/if}}">
				<meta property="og:image:width" content="1600">
				<meta property="og:image:height" content="840">
				<meta name="twitter:image" content="{{@custom.og_service_url}}?title={{encode title}}&site={{encode @site.title}}{{#if excerpt}}&excerpt={{encode (excerpt characters="50")}}{{/if}}{{#if primary_author}}&author={{encode primary_author.name}}{{#if primary_author.profile_image}}&avatar={{encode (img_url primary_author.profile_image size="s" format="jpeg" absolute="true")}}{{/if}}{{/if}}{{#if primary_tag}}&tag={{encode primary_tag.name}}{{/if}}&date={{encode (date format="YYYY-MM-DD")}}&reading={{encode (reading_time)}}{{#if feature_image}}&image={{encode (img_url feature_image size="l" format="jpeg" absolute="true")}}{{/if}}{{#if @site.icon}}&icon={{encode (img_url @site.icon size="s" format="png" absolute="true")}}{{/if}}{{#if @custom.og_service_theme}}&theme={{encode @custom.og_service_theme}}{{/if}}{{#if updated_at}}&ts={{date updated_at format="x"}}{{/if}}">
			{{/post}}
		{{/is}}
		{{#is "tag"}}
			<meta property="og:image" content="{{@custom.og_service_url}}?title={{encode tag.name}}&site={{encode @site.title}}{{#if tag.description}}&excerpt={{encode tag.description}}{{/if}}&tag={{encode tag.name}}{{#if tag.feature_image}}&image={{encode (img_url tag.feature_image size="l" format="jpeg" absolute="true")}}{{/if}}{{#if @site.icon}}&icon={{encode (img_url @site.icon size="s" format="png" absolute="true")}}{{/if}}{{#if @custom.og_service_theme}}&theme={{encode @custom.og_service_theme}}{{/if}}{{#if tag.updated_at}}&ts={{date tag.updated_at format="x"}}{{/if}}">
			<meta property="og:image:width" content="1600">
			<meta property="og:image:height" content="840">
			<meta name="twitter:image" content="{{@custom.og_service_url}}?title={{encode tag.name}}&site={{encode @site.title}}{{#if tag.description}}&excerpt={{encode tag.description}}{{/if}}&tag={{encode tag.name}}{{#if tag.feature_image}}&image={{encode (img_url tag.feature_image size="l" format="jpeg" absolute="true")}}{{/if}}{{#if @site.icon}}&icon={{encode (img_url @site.icon size="s" format="png" absolute="true")}}{{/if}}{{#if @custom.og_service_theme}}&theme={{encode @custom.og_service_theme}}{{/if}}{{#if tag.updated_at}}&ts={{date tag.updated_at format="x"}}{{/if}}">
		{{/is}}
		{{#is "author"}}
			{{#primary_author}}
				<meta property="og:image" content="{{@custom.og_service_url}}?title={{encode name}}&site={{encode @site.title}}{{#if bio}}&excerpt={{encode bio}}{{/if}}&author={{encode name}}{{#if profile_image}}&avatar={{encode (img_url profile_image size="s" format="jpeg" absolute="true")}}{{/if}}{{#if cover_image}}&image={{encode (img_url cover_image size="l" format="jpeg" absolute="true")}}{{else}}{{#if profile_image}}&image={{encode (img_url profile_image size="s" format="jpeg" absolute="true")}}{{/if}}{{/if}}{{#if @site.icon}}&icon={{encode (img_url @site.icon size="s" format="png" absolute="true")}}{{/if}}{{#if @custom.og_service_theme}}&theme={{encode @custom.og_service_theme}}{{/if}}{{#if updated_at}}&ts={{date updated_at format="x"}}{{/if}}">
				<meta property="og:image:width" content="1600">
				<meta property="og:image:height" content="840">
				<meta name="twitter:image" content="{{@custom.og_service_url}}?title={{encode name}}&site={{encode @site.title}}{{#if bio}}&excerpt={{encode bio}}{{/if}}&author={{encode name}}{{#if profile_image}}&avatar={{encode (img_url profile_image size="s" format="jpeg" absolute="true")}}{{/if}}{{#if cover_image}}&image={{encode (img_url cover_image size="l" format="jpeg" absolute="true")}}{{else}}{{#if profile_image}}&image={{encode (img_url profile_image size="s" format="jpeg" absolute="true")}}{{/if}}{{/if}}{{#if @site.icon}}&icon={{encode (img_url @site.icon size="s" format="png" absolute="true")}}{{/if}}{{#if @custom.og_service_theme}}&theme={{encode @custom.og_service_theme}}{{/if}}{{#if updated_at}}&ts={{date updated_at format="x"}}{{/if}}">
			{{/primary_author}}
		{{/is}}
	{{/if}}
</head>

<body class="{{body_class}}"
	data-i18n-copy="{{t "Copy"}}"
	data-i18n-copied="{{t "Copied!"}}"
	data-i18n-copy-code="{{t "Copy code"}}"
	data-i18n-toc-label="{{t "Table of Contents"}}"
	data-i18n-on-this-page="{{t "On this page"}}"
	data-i18n-open-toc="{{t "Open table of contents"}}"
	data-i18n-close-toc="{{t "Close table of contents"}}">

	<div class="viewport">
			<div class="nav-header">
				<nav class="nav-wrapper" aria-label="{{t "Main"}}">
					{{#if @site.logo}}
						<span class="logo">
							<a href="{{@site.url}}" title="{{t "Home"}}"><img src="{{img_url @site.logo size="s"}}" alt="{{t "Logo"}}" /></a>
						</span>
					{{/if}}
					{{navigation}}
					<a class="nav-search" href="#search" role="button" aria-label="{{t "Search"}}" data-ghost-search><i class="icon icon-search" aria-hidden="true">{{> "icons/icon-search"}}</i></a>
					{{#if @site.members_enabled}}
						<span class="nav-members">
							{{#unless @member}}
								{{#unless @site.members_invite_only}}
									<a class="nav-button-secondary" href="#/portal/signin" data-portal="signin">{{t "Sign in"}}</a>
								{{#unless hideSubscribeButton}}
									<a class="nav-button-primary" href="#/portal/signup" data-portal="signup">{{t "Subscribe"}}</a>
								{{/unless}}
							{{else}}
								<a class="nav-button-primary" href="#/portal/signin" data-portal="signin">{{t "Sign in"}}</a>
							{{/unless}}
						{{else}}
							<a class="nav-button-secondary" href="#/portal/account" data-portal="account">{{t "Account"}}</a>
						{{/unless}}
					</span>
				{{/if}}
			</nav>

				<div class="nav-wrapper-control">
					<div class="inner">
						<a class="nav-menu" href="#menu" role="button" aria-expanded="false"><i class="icon icon-menu" aria-hidden="true">{{> "icons/icon-menu"}}</i> {{t "Menu"}}</a>
						<a class="nav-search" href="#search" role="button" aria-label="{{t "Search"}}" data-ghost-search><i class="icon icon-search" aria-hidden="true">{{> "icons/icon-search"}}</i></a>
					</div>
				</div>
			</div>
			<div class="nav-close" role="button" aria-label="{{t "Close"}}" tabindex="0" aria-hidden="true"></div>

		<section class="page-wrapper">

			{{{body}}}

			<footer class="nav-footer">
				<div class="footer-main">
					{{!-- Left: Copyright --}}
					<div class="footer-left">
						<span class="footer-copyright">&copy; {{date format='YYYY'}} {{@site.title}}</span>
						<span class="footer-credits">{{t "Published with"}} <a href="https://ghost.org">Ghost</a> & <a href="https://github.com/bunizao/attegi">Attegi</a></span>
					</div>

					{{!-- Center: Custom text (supports HTML) --}}
					{{#if @custom.footer_text}}
					<div class="footer-center">
						<span class="footer-custom-text">{{{@custom.footer_text}}}</span>
					</div>
					{{/if}}

					{{!-- Right: Social + Theme toggle --}}
					<div class="footer-right">
						<div class="footer-social">
								<a class="social-link" aria-label="{{t "RSS"}}" href="{{@site.url}}/rss/" title="{{t "RSS"}}">
									<i class="icon icon-rss" aria-hidden="true">{{> "icons/icon-rss"}}</i>
								</a>
								{{#if @site.twitter}}<a class="social-link" aria-label="{{t "Twitter"}}" href="https://twitter.com/{{@site.twitter}}" title="{{t "Twitter"}}" target="_blank" rel="noopener">
									<i class="icon icon-twitter" aria-hidden="true">{{> "icons/icon-twitter"}}</i>
								</a>{{/if}}
								{{#if @site.facebook}}<a class="social-link" aria-label="{{t "Facebook"}}" href="https://www.facebook.com/{{@site.facebook}}" title="{{t "Facebook"}}" target="_blank" rel="noopener">
									<i class="icon icon-facebook" aria-hidden="true">{{> "icons/icon-facebook"}}</i>
								</a>{{/if}}
							{{#if @custom.instagram_url}}<a class="social-link" aria-label="{{t "Instagram"}}" href="{{@custom.instagram_url}}" title="{{t "Instagram"}}" target="_blank" rel="noopener">
								<i class="icon icon-instagram" aria-hidden="true">{{> "icons/icon-instagram"}}</i>
							</a>{{/if}}
							{{#if @custom.github_url}}<a class="social-link" aria-label="{{t "GitHub"}}" href="{{@custom.github_url}}" title="{{t "GitHub"}}" target="_blank" rel="noopener">
								<i class="icon icon-github" aria-hidden="true">{{> "icons/icon-github"}}</i>
							</a>{{/if}}
							{{#if @custom.telegram_url}}<a class="social-link" aria-label="{{t "Telegram"}}" href="{{@custom.telegram_url}}" title="{{t "Telegram"}}" target="_blank" rel="noopener">
								<i class="icon icon-telegram" aria-hidden="true">{{> "icons/icon-telegram"}}</i>
							</a>{{/if}}
							{{#if @custom.discord_url}}<a class="social-link" aria-label="{{t "Discord"}}" href="{{@custom.discord_url}}" title="{{t "Discord"}}" target="_blank" rel="noopener">
								<i class="icon icon-discord" aria-hidden="true">{{> "icons/icon-discord"}}</i>
							</a>{{/if}}
							{{#if @custom.bluesky_url}}<a class="social-link" aria-label="{{t "Bluesky"}}" href="{{@custom.bluesky_url}}" title="{{t "Bluesky"}}" target="_blank" rel="noopener">
								<i class="icon icon-bluesky" aria-hidden="true">{{> "icons/icon-bluesky"}}</i>
							</a>{{/if}}
							{{#if @custom.email_address}}<a class="social-link" aria-label="{{t "Email"}}" href="mailto:{{@custom.email_address}}" title="{{t "Email"}}">
								<i class="icon icon-mail" aria-hidden="true">{{> "icons/icon-mail"}}</i>
							</a>{{/if}}
						</div>
						<span class="footer-divider"></span>
						<button class="theme-toggle js-theme" aria-label="{{t "Toggle theme"}}" data-system="{{t "System"}}" data-dark="{{t "Dark"}}" data-light="{{t "Light"}}">
							<i class="icon theme-icon-sun" aria-hidden="true">{{> "icons/icon-sun"}}</i>
							<i class="icon theme-icon-moon" aria-hidden="true">{{> "icons/icon-moon"}}</i>
							<i class="icon theme-icon-monitor" aria-hidden="true">{{> "icons/icon-monitor"}}</i>
						</button>
					</div>
				</div>
			</footer>

		</section>
	</div>

	<svg class="liquid-glass-filter" aria-hidden="true" focusable="false" width="0" height="0" style="position:absolute;overflow:hidden">
		<defs>
			<!-- Liquid glass filter with displacement for curving effect -->
			<filter id="liquid-glass" x="-50%" y="-50%" width="200%" height="200%">
				<!-- Generate organic noise pattern for displacement -->
				<feTurbulence type="fractalNoise" baseFrequency="0.015" numOctaves="3" seed="5" result="noise" />
				<!-- Soften the noise -->
				<feGaussianBlur in="noise" stdDeviation="1.5" result="softNoise" />
				<!-- Blur source for glass effect -->
				<feGaussianBlur in="SourceGraphic" stdDeviation="8" result="blur" />
				<!-- Apply displacement for liquid warping -->
				<feDisplacementMap in="blur" in2="softNoise" scale="25" xChannelSelector="R" yChannelSelector="G" result="displaced" />
				<!-- Boost saturation slightly -->
				<feColorMatrix in="displaced" type="saturate" values="1.15" />
			</filter>
			<!-- Simple frosted blur fallback -->
			<filter id="frosted" x="-50%" y="-50%" width="200%" height="200%">
				<feGaussianBlur in="SourceGraphic" stdDeviation="12" result="blur" />
				<feColorMatrix in="blur" type="saturate" values="1.2" />
			</filter>
		</defs>
	</svg>

	{{!-- Load basic scripts (no defer, placed before </body> for reliability) --}}
	<script src="{{asset "js/script.js"}}"></script>
	<script>
		// Conditionally load GLightbox only for gallery images
		(function() {
			function initGLightbox() {
				var galleryImages = document.querySelectorAll('.kg-gallery-image img');
				if (galleryImages.length === 0) return; // No gallery images, skip loading

				function getNumericValue(value) {
					if (!value) return null;
					var parsed = parseInt(value, 10);
					return isNaN(parsed) ? null : parsed;
				}

				function getLargestSrcFromSrcset(srcset) {
					if (!srcset) return '';
					var candidates = srcset.split(',').map(function (item) {
						return item.trim();
					}).filter(Boolean);
					var bestUrl = '';
					var bestWidth = 0;
					candidates.forEach(function (candidate) {
						var parts = candidate.split(/\s+/);
						var url = parts.shift();
						var width = 0;
						parts.forEach(function (part) {
							if (part.slice(-1) === 'w') {
								var parsed = parseInt(part, 10);
								if (!isNaN(parsed)) {
									width = parsed;
								}
							}
						});
						if (url && width > bestWidth) {
							bestWidth = width;
							bestUrl = url;
						}
					});
					return bestUrl;
				}

				function isGhostOriginal(src) {
					return /\/content\/images\//.test(src) && !/\/content\/images\/size\//.test(src);
				}

				function pickLightboxSource(img) {
					var src = img.getAttribute('src') || img.src;
					if (!src) return '';
					if (isGhostOriginal(src)) return src;
					var srcset = img.getAttribute('srcset');
					var largest = getLargestSrcFromSrcset(srcset);
					return largest || src;
				}

				// Load CSS
				var css = document.createElement('link');
				css.rel = 'stylesheet';
				css.href = '{{asset "css/glightbox.min.css"}}';
				document.head.appendChild(css);

				// Wrap gallery images only
				galleryImages.forEach(function(img) {
					if (!img.closest('a')) {
						var wrapper = document.createElement('a');
						var lightboxSrc = pickLightboxSource(img);
						wrapper.href = lightboxSrc || img.src;
						wrapper.classList.add('glightbox');
						wrapper.setAttribute('data-type', 'image');
						var width = getNumericValue(img.getAttribute('width')) || img.naturalWidth;
						var height = getNumericValue(img.getAttribute('height')) || img.naturalHeight;
						if (width && height) {
							wrapper.setAttribute('data-width', String(width));
							wrapper.setAttribute('data-height', String(height));
						}
						// Use gallery card's position as unique ID
						var galleryCard = img.closest('.kg-gallery-card');
						var galleryId = 'gallery-' + Array.prototype.indexOf.call(
							document.querySelectorAll('.kg-gallery-card'),
							galleryCard
						);
						wrapper.setAttribute('data-gallery', galleryId);
						img.parentNode.insertBefore(wrapper, img);
						wrapper.appendChild(img);
					}
				});

				// Load JS
				var script = document.createElement('script');
				script.src = '{{asset "js/glightbox.min.js"}}';
				script.onload = function() {
					if (typeof GLightbox !== 'undefined') {
						var lightbox = GLightbox({
							selector: '.glightbox',
							type: 'image',
							touchNavigation: true,
							loop: true,
							closeOnOutsideClick: true,
							openEffect: 'fade',
							closeEffect: 'fade',
							zoomable: true,
							draggable: true,
							dragAutoSnap: true,
							preload: true,
							// Enhanced touch settings for better mobile experience
							touchFollowAxis: true,
							moreLength: 0
						});

						// Add WebKit-specific gesture enhancements
						lightbox.on('open', function(slide) {
							var container = document.querySelector('.gslide-media');
							if (!container) return;

							var img = container.querySelector('img');
							if (!img) return;

							// Variables for pinch-to-zoom
							var initialDistance = 0;
							var currentScale = 1;
							var lastTapTime = 0;
							var doubleTapDelay = 300;

							// Get distance between two touch points
							function getDistance(touches) {
								var dx = touches[0].clientX - touches[1].clientX;
								var dy = touches[0].clientY - touches[1].clientY;
								return Math.sqrt(dx * dx + dy * dy);
							}

							// Handle pinch-to-zoom
							function handleTouchStart(e) {
								if (e.touches.length === 2) {
									e.preventDefault();
									initialDistance = getDistance(e.touches);
								}
							}

							function handleTouchMove(e) {
								if (e.touches.length === 2) {
									e.preventDefault();
									var currentDistance = getDistance(e.touches);
									var scale = currentDistance / initialDistance;
									currentScale = Math.max(1, Math.min(scale * currentScale, 4));

									if (img.style) {
										img.style.transform = 'scale(' + currentScale + ')';
										img.style.transition = 'none';
									}
								}
							}

							function handleTouchEnd(e) {
								if (e.touches.length < 2) {
									initialDistance = 0;
									if (currentScale < 1.1) {
										currentScale = 1;
										if (img.style) {
											img.style.transform = 'scale(1)';
											img.style.transition = 'transform 0.3s ease';
										}
									}
								}

								// Handle double-tap to zoom
								if (e.touches.length === 0 && e.changedTouches.length === 1) {
									var currentTime = new Date().getTime();
									var tapLength = currentTime - lastTapTime;

									if (tapLength < doubleTapDelay && tapLength > 0) {
										e.preventDefault();
										if (currentScale > 1) {
											currentScale = 1;
											if (img.style) {
												img.style.transform = 'scale(1)';
												img.style.transition = 'transform 0.3s ease';
											}
										} else {
											currentScale = 2;
											if (img.style) {
												img.style.transform = 'scale(2)';
												img.style.transition = 'transform 0.3s ease';
											}
										}
									}
									lastTapTime = currentTime;
								}
							}

							// Add event listeners
							container.addEventListener('touchstart', handleTouchStart, { passive: false });
							container.addEventListener('touchmove', handleTouchMove, { passive: false });
							container.addEventListener('touchend', handleTouchEnd, { passive: false });

							// Cleanup on close
							lightbox.on('close', function() {
								container.removeEventListener('touchstart', handleTouchStart);
								container.removeEventListener('touchmove', handleTouchMove);
								container.removeEventListener('touchend', handleTouchEnd);
							});
						});
					}
				};
				document.body.appendChild(script);
			}

			if (document.readyState === 'loading') {
				document.addEventListener('DOMContentLoaded', initGLightbox);
			} else {
				initGLightbox();
			}
		})();
	</script>

	{{!-- The #block helper will pull in data from the #contentFor other template files. In this case, there's some JavaScript which we only want to use in post.hbs, but it needs to be included down here, after jQuery has already loaded. --}}
	{{{block "scripts"}}}

	{{!-- Ghost outputs important scripts and data with this tag - it should always be the very last thing before the closing body tag --}}
	{{ghost_foot}}

</body>
</html>
